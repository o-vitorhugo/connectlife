<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agendar Atividade - Connect Life</title>
  <link rel="icon" href="./images/handshake-emoji.png" type="image/x-icon">
  <link rel="stylesheet" href="./styles/main.css" />
</head>

<body>
  <header>
    <div class="header-content">
      <a href="./index.html" class="logo">ü§ù Connect Life</a>
      <nav>
        <ul>
          <li><a href="./dashboard.html">Dashboard</a></li>
          <li><a href="./atividades.html">Atividades</a></li>
          <li><a href="./agendamentos.html">Agendamentos</a></li>
          <li><a href="./calendario.html">Calend√°rio</a></li>
          <li><a href="./historico.html">Hist√≥rico</a></li>
          <li><a href="./eventos.html">Eventos</a></li>
        </ul>
      </nav>
      <div class="user-menu">
        <span id="user-name"></span>
        <span id="user-role" class="role-badge"></span>
        <button id="logout-btn" class="btn btn-outline">Sair</button>
      </div>
    </div>
  </header>

  <main style="padding: 2rem 1rem">
    <div class="container" style="max-width: 900px">
      <h1 style="margin-bottom: 2rem">Agendar Atividade</h1>

      <div class="grid grid-cols-2" style="margin-bottom: 2rem">
        <div class="card" id="activity-info"></div>

        <div class="card">
          <h2 class="card-title" style="margin-bottom: 1rem">Detalhes do Agendamento</h2>
          <form id="schedule-form">
            <div class="form-group">
              <label for="date">Data</label>
              <input type="date" id="date" name="date" required min="" />
            </div>

            <div class="form-group">
              <label for="time">Hor√°rio</label>
              <input type="time" id="time" name="time" required />
            </div>

            <div class="form-group" id="participant-group">
              <label for="participant">Selecione o Participante</label>
              <select id="participant" name="participant">
                <option value="">Escolha...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="notes">Observa√ß√µes (opcional)</label>
              <textarea id="notes" name="notes" placeholder="Informa√ß√µes adicionais sobre o agendamento"></textarea>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%">Confirmar Agendamento</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>Connect Life</h3>
        <p>Conectando gera√ß√µes atrav√©s de atividades significativas.</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Connect Life. Todos os direitos reservados.</p>
    </div>
  </footer>

  <script src="./js/api.js"></script>

  <script src="./js/global.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const usuario = API.usuarios.obterUsuarioAtual()
        if (!usuario) {
          window.location.href = "./login.html"
          return
        }

        if (usuario.papel.toUpperCase() !== "IDOSO") {
          alert("Apenas idosos podem criar agendamentos.")
          window.location.href = "./atividades.html"
          return
        }

        const parametrosUrl = new URLSearchParams(window.location.search)
        const idAtividade = parametrosUrl.get("id")

        const atividades = await API.atividades.listar()
        const atividade = atividades.find((a) => a.id == idAtividade)

        if (!atividade) {
          alert("Atividade n√£o encontrada!")
          window.location.href = "./atividades.html"
          return
        }

        document.getElementById("activity-info").innerHTML = `
          <img src="${atividade.imagem || "./img/padrao.jpg"}"
            alt="${atividade.titulo}"
            style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:1rem;">
          <h2>${atividade.titulo}</h2>
          <p>${atividade.descricao}</p>
          <div style="display:flex; gap:0.5rem;">
            <span class="badge badge-info">${atividade.categoria}</span>
            <span class="badge badge-warning">${atividade.dificuldade || "N√≠vel n√£o informado"}</span>
          </div>
          <p>‚è±Ô∏è Dura√ß√£o: ${atividade.duracao || "N√£o informada"}</p>
        `

        const hoje = new Date().toISOString().split("T")[0]
        document.getElementById("date").setAttribute("min", hoje)

        const usuarios = await API.usuarios.listarInformacoes()
        const seletor = document.getElementById("participant")
        const voluntarios = usuarios.filter((u) => u.papel && u.papel.toUpperCase() === "VOLUNTARIO")

        seletor.innerHTML = `
            <option value="">Deixar em aberto para volunt√°rios</option>
            ${voluntarios
            .map(
              (v) => `
              <option value="${v.id}">${v.nome}</option>
            `
            )
            .join("")}
          `

        document.getElementById("schedule-form").addEventListener("submit", async (e) => {
          e.preventDefault()

          const form = new FormData(e.target)
          const participanteId = form.get("participant") ? parseInt(form.get("participant")) : null

          const agendamento = {
            id_atividade: parseInt(idAtividade),
            id_voluntario: participanteId,
            data: form.get("date"),
            hora: form.get("time"),
            observacoes: form.get("notes") || "",
          }

          await API.calendario.adicionarAtividade(agendamento)

          alert("Agendamento criado com sucesso!")
          window.location.href = "./agendamentos.html"
        })
      } catch (erro) {
        console.error("Erro ao carregar agendamento:", erro)
        alert("Ocorreu um erro ao carregar a p√°gina. Tente novamente.")
      }
    })
  </script>
</body>

</html>